# This file is the full Botilka config, adapt to your needs
framework:
    messenger:
        default_bus: messenger.bus.commands
        buses:
            messenger.bus.commands:
                middleware:
                    - doctrine_transaction_middleware
                    - Botilka\Infrastructure\Symfony\Messenger\Middleware\EventDispatcherBusMiddleware
            messenger.bus.events: ~
            messenger.bus.queries: ~

services:
    _defaults:
        autowire: true
        autoconfigure: true
        public: false
        bind:
            $commandBus: '@Botilka\Application\Command\CommandBus'
            $queryBus: '@Botilka\Application\Query\QueryBus'
            $eventBus: '@Botilka\Event\EventBus'

    # EventStore
    Botilka\Infrastructure\Doctrine\EventStoreDoctrine: ~
    Botilka\EventStore\EventStore: '@Botilka\Infrastructure\Doctrine\EventStoreDoctrine'

    # Event dispatcher
    Botilka\Event\DefaultEventDispatcher: ~
    Botilka\Event\EventDispatcherInterface: '@Botilka\Event\DefaultEventDispatcher'

    # Event replayer
    Botilka\Event\DefaultEventReplayer: ~
    Botilka\Event\EventReplayer: '@Botilka\Event\DefaultEventReplayer'
    Botilka\Ui\Console\ReplayCommand: ~

    # Buses
    Botilka\Event\EventBus: '@Botilka\Infrastructure\Symfony\Messenger\MessengerEventBus'
    Botilka\Application\Command\CommandBus: '@Botilka\Infrastructure\Symfony\Messenger\MessengerCommandBus'
    Botilka\Application\Query\QueryBus: '@Botilka\Infrastructure\Symfony\Messenger\MessengerQueryBus'

    # API Platform bridge
    Botilka\Bridge\ApiPlatform\Description\DescriptionContainer: ~
    Botilka\Bridge\ApiPlatform\DataProvider\CommandDataProvider: ~
    Botilka\Bridge\ApiPlatform\DataProvider\QueryDataProvider: ~
    Botilka\Bridge\ApiPlatform\Action\:
        resource: '%kernel.project_dir%/vendor/botilka/botilka/src/Bridge/ApiPlatform/Action/*'
        public: true

    # Messenger buses implementation
    Botilka\Infrastructure\Symfony\Messenger\MessengerCommandBus:
        arguments:
          $bus: '@messenger.bus.commands'

    Botilka\Infrastructure\Symfony\Messenger\MessengerQueryBus:
        arguments:
            $bus: '@messenger.bus.queries'

    Botilka\Infrastructure\Symfony\Messenger\MessengerEventBus:
        arguments:
            $bus: '@messenger.bus.events'

    # Messenger event dispatcher middleware
    Botilka\Infrastructure\Symfony\Messenger\Middleware\EventDispatcherBusMiddleware: ~

    # Doctrine transaction middleware
    # https://symfony.com/doc/4.1/messenger.html#using-middleware-factories
    doctrine.orm.messenger.middleware_factory.transaction:
        class: Symfony\Bridge\Doctrine\Messenger\DoctrineTransactionMiddlewareFactory
        arguments: ['@doctrine']

    messenger.middleware.doctrine_transaction_middleware:
        class: Symfony\Bridge\Doctrine\Messenger\DoctrineTransactionMiddleware
        factory: 'doctrine.orm.messenger.middleware_factory.transaction:createMiddleware'
        abstract: true
        arguments: ['default']

api_platform:
    mapping:
        paths:
            # expose commands & queries
            - '%kernel.project_dir%/vendor/botilka/botilka/src/Bridge/ApiPlatform/Resource'
            # expose EventStore
            - '%kernel.project_dir%/vendor/botilka/botilka/src/Infrastructure/Doctrine'

doctrine:
    orm:
        mappings:
            # include Event item from EventStore to be managed by Doctrine, enable schema update & migration
            Botilka:
                is_bundle: false
                type: annotation
                dir: '%kernel.project_dir%/vendor/botilka/botilka/src/Infrastructure/Doctrine'
                prefix: 'Botilka\Infrastructure\Doctrine'
                alias: Botilka
